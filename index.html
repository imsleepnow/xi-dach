<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X√¨ D√°ch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        .card { width: 60px; height: 90px; border-radius: 5px; display: inline-flex; justify-content: center; align-items: center; margin: 2px; font-weight: bold; background: white; border: 1px solid #ccc; position: relative; }
        .card.red { color: red; } .card.black { color: black; }
        .card-back { background: repeating-linear-gradient(45deg, #606dbc, #606dbc 10px, #465298 10px, #465298 20px); color: transparent; }
        .bg-felt { background-color: #35654d; }
        /* Hi·ªáu ·ª©ng n·ªïi */
        .chip { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen">
    <div id="app" class="container mx-auto p-4 relative max-w-4xl">
        
        <button @click="showTutorial = !showTutorial" class="absolute top-2 right-2 md:top-4 md:right-4 bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-1 px-3 rounded z-50 text-sm md:text-base">
            ? H∆∞·ªõng d·∫´n
        </button>

        <div v-if="showTutorial" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" @click.self="showTutorial = false">
            <div class="bg-white text-black p-6 rounded-lg max-w-lg w-full shadow-2xl">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">Lu·∫≠t ch∆°i X√¨ D√°ch</h2>
                <ul class="list-disc pl-5 space-y-2 text-sm md:text-base">
                    <li>**M·ª•c ti√™u:** T·ªïng ƒëi·ªÉm g·∫ßn 21 nh·∫•t. Qu√° 21 l√† "Qu·∫Øc" (Thua).</li>
                    <li>**ƒêi·ªÉm:** J, Q, K = 10. A = 1, 10, ho·∫∑c 11.</li>
                    <li>**Ng≈© Linh:** 5 l√° b√†i m√† t·ªïng ƒëi·ªÉm <= 21 (Th·∫Øng tuy·ªát ƒë·ªëi).</li>
                    <li>**Ti·ªÅn:** V·ªën $100,000. C∆∞·ª£c $1,000/v√°n.</li>
                    <li>**Ch·∫ø ƒë·ªô:**
                        <br>- <span class="font-bold text-blue-600">Bot (1 ng∆∞·ªùi):</span> B·∫°n vs M√°y.
                        <br>- <span class="font-bold text-purple-600">Solo (2 ng∆∞·ªùi):</span> 1 ng∆∞·ªùi l√†m c√°i, 1 ng∆∞·ªùi l√†m con.
                        <br>- <span class="font-bold text-red-600">Multi (Max 4):</span> Nhi·ªÅu ng∆∞·ªùi ƒë·∫•u v·ªõi Bot c√°i.
                    </li>
                </ul>
                <button @click="showTutorial = false" class="mt-6 bg-green-600 hover:bg-green-700 text-white font-bold px-4 py-3 rounded w-full transition">ƒê√£ hi·ªÉu, ƒë√≥ng l·∫°i!</button>
            </div>
        </div>

        <div v-if="view === 'login'" class="flex flex-col items-center justify-center min-h-[80vh]">
            <h1 class="text-4xl md:text-6xl font-extrabold mb-8 text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500">X√å D√ÅCH</h1>
            <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md border border-gray-700">
                <label class="block mb-2 font-bold text-gray-300">T√™n hi·ªÉn th·ªã:</label>
                <input v-model="username" type="text" class="w-full p-3 rounded bg-gray-700 text-white border border-gray-600 focus:border-green-500 outline-none mb-4" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." @keyup.enter="enterLobby">
                
                <label class="block mb-2 font-bold text-gray-300">M√£ ph√≤ng (T√πy ch·ªçn):</label>
                <input v-model="roomIdInput" type="text" class="w-full p-3 rounded bg-gray-700 text-white border border-gray-600 focus:border-green-500 outline-none mb-6" placeholder="VD: p123 (ƒê·ªÉ tr·ªëng s·∫Ω t·ª± t·∫°o)">
                
                <button @click="enterLobby" :disabled="!username" class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 py-3 rounded font-bold text-lg disabled:opacity-50 transition transform active:scale-95">
                    V√ÄO CH∆†I NGAY ‚ûî
                </button>
            </div>
        </div>

        <div v-else-if="view === 'lobby'" class="flex flex-col items-center mt-10">
            <h2 class="text-3xl font-bold mb-2">Ph√≤ng: <span class="text-yellow-400 font-mono">{{ roomId }}</span></h2>
            <p class="text-gray-400 mb-6 text-sm">G·ª≠i m√£ ph√≤ng n√†y cho b·∫°n b√® ƒë·ªÉ c√πng ch∆°i!</p>
            
            <div class="bg-gray-800 p-6 rounded-lg w-full max-w-2xl mb-6 border border-gray-700">
                <h3 class="text-xl mb-4 text-gray-300 border-b border-gray-600 pb-2">Ng∆∞·ªùi ch∆°i ƒëang ƒë·ª£i:</h3>
                <div class="flex flex-wrap gap-4">
                    <div v-for="p in players" :key="p.id" class="flex items-center gap-3 bg-gray-700 px-4 py-3 rounded-lg shadow-md border border-gray-600">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center font-bold text-sm">
                            {{ p.name.charAt(0).toUpperCase() }}
                        </div>
                        <div class="flex flex-col">
                            <span class="font-bold leading-tight">{{ p.name }}</span>
                            <span v-if="p.isHost" class="text-yellow-400 text-[10px] font-bold">üëë CH·ª¶ PH√íNG</span>
                        </div>
                        <span class="text-green-400 font-mono font-bold ml-2">${{ p.money.toLocaleString() }}</span>
                    </div>
                </div>
                <div v-if="players.length === 0" class="text-gray-500 italic">ƒêang k·∫øt n·ªëi...</div>
            </div>

            <div v-if="isMyHost" class="bg-gray-800 p-6 rounded-lg w-full max-w-2xl text-center border border-gray-700">
                <h3 class="text-xl mb-6 text-yellow-400 font-bold uppercase tracking-wide">Ch·ªçn ch·∫ø ƒë·ªô ch∆°i</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button @click="startGame('bot')" class="bg-blue-600 p-4 rounded hover:bg-blue-500 transition transform hover:-translate-y-1 shadow-lg">
                        <div class="font-bold text-lg">ü§ñ ƒê·∫•u Bot</div>
                        <div class="text-xs text-blue-200 mt-1">1 m√¨nh luy·ªán t·∫≠p</div>
                    </button>
                    <button @click="startGame('solo')" class="bg-purple-600 p-4 rounded hover:bg-purple-500 transition transform hover:-translate-y-1 shadow-lg">
                        <div class="font-bold text-lg">‚öîÔ∏è Solo PvP</div>
                        <div class="text-xs text-purple-200 mt-1">1 C√°i vs 1 Con (2 ng∆∞·ªùi)</div>
                    </button>
                    <button @click="startGame('multi')" class="bg-red-600 p-4 rounded hover:bg-red-500 transition transform hover:-translate-y-1 shadow-lg">
                        <div class="font-bold text-lg">üî• Nhi·ªÅu ng∆∞·ªùi</div>
                        <div class="text-xs text-red-200 mt-1">C·∫£ nh√≥m ƒë·∫•u Bot (Max 4)</div>
                    </button>
                </div>
                <p v-if="errorMessage" class="text-red-400 mt-4 bg-red-900/30 p-2 rounded font-bold animate-bounce">{{ errorMessage }}</p>
            </div>
            <div v-else class="text-center p-8">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-400 mx-auto mb-4"></div>
                <p class="text-gray-400 animate-pulse">ƒêang ƒë·ª£i ch·ªß ph√≤ng ch·ªçn game...</p>
            </div>
        </div>

        <div v-else-if="view === 'game'" class="flex flex-col justify-between h-full bg-felt rounded-xl border-[12px] border-[#4a2c2a] shadow-2xl min-h-[85vh] relative overflow-hidden">
            
            <div class="flex flex-col items-center pt-6 pb-4 bg-black/20 w-full relative">
                <div class="absolute top-2 left-4 text-xs text-white/50">B√†n: {{ roomId }} | Mode: {{ gameMode.toUpperCase() }}</div>
                
                <div class="mb-3 font-bold text-xl flex flex-col items-center">
                    <div class="flex items-center gap-2">
                         <span v-if="gameMode === 'solo' && dealerPlayer" class="text-yellow-200">{{ dealerPlayer.name }} (Nh√† C√°i)</span>
                         <span v-else class="text-red-300 font-mono text-2xl">BOT DEALER</span>
                    </div>
                    <span class="text-xs bg-black/60 px-3 py-1 rounded-full text-yellow-400 mt-1 border border-yellow-600/50">
                        V·ªën: ${{ getDealerMoney().toLocaleString() }}
                    </span>
                </div>

                <div class="flex gap-2 relative h-[100px] items-center">
                    <div v-for="(card, index) in dealerHand" :key="index" 
                         :class="['card shadow-lg transform transition-transform hover:scale-105', getCardColor(card)]"
                         :style="{transform: `rotate(${(index - 0.5) * 5}deg)`}">
                        
                        <div v-if="index === 0 && !gameEnded && !isDealerTurn && gameMode !== 'solo'" class="card-back w-full h-full absolute top-0 left-0 rounded-[4px]"></div>
                        
                        <span v-else class="text-2xl">{{ card.rank }}{{ card.suit }}</span>
                    </div>
                </div>

                <div class="mt-2 font-bold text-yellow-100 bg-black/40 px-3 rounded">
                    <span v-if="gameEnded || isDealerTurn || gameMode === 'solo'">{{ calculateHandScore(dealerHand) }} ƒëi·ªÉm</span>
                    <span v-else>? ƒëi·ªÉm</span>
                </div>
            </div>

            <div v-if="gameEnded" class="absolute inset-0 flex items-center justify-center z-10 pointer-events-none">
                <div class="bg-black/70 text-white px-8 py-4 rounded-xl backdrop-blur-sm border border-white/20">
                    <h2 class="text-3xl font-bold text-center text-yellow-400">K·∫æT TH√öC V√ÅN</h2>
                    <p class="text-center text-sm mt-1">Ch·ªß ph√≤ng h√£y b·∫Øt ƒë·∫ßu v√°n m·ªõi</p>
                </div>
            </div>

            <div class="flex-1 flex flex-wrap justify-center content-end items-end gap-2 md:gap-8 pb-24 px-2 w-full">
                <div v-for="p in players" :key="p.id" 
                     :class="['relative flex flex-col items-center p-3 rounded-lg transition-all min-w-[120px]', 
                              currentTurnId === p.id ? 'bg-yellow-500/20 border-2 border-yellow-400 shadow-[0_0_15px_rgba(250,204,21,0.5)]' : 'bg-black/40 border border-white/10',
                              (gameMode === 'solo' && p.id === dealerId) ? 'hidden' : '']">
                    
                    <div class="flex flex-col items-center mb-2">
                        <div class="font-bold text-sm md:text-base text-white shadow-black drop-shadow-md">
                            {{ p.name }} <span v-if="p.id === myId" class="text-green-300">(B·∫°n)</span>
                        </div>
                        <div class="text-yellow-300 text-xs font-mono bg-black/50 px-2 rounded">${{ p.money.toLocaleString() }}</div>
                    </div>
                    
                    <div class="flex -space-x-6 mb-2 h-[80px]">
                        <div v-for="(card, idx) in p.hand" :key="idx" 
                             :class="['card shadow-md', getCardColor(card)]" 
                             style="z-index: 10;"
                             :style="{transform: `translateY(${idx * -2}px)`}">
                            <span class="text-xl">{{ card.rank }}{{ card.suit }}</span>
                        </div>
                    </div>
                    
                    <div class="text-center min-h-[1.5em]">
                        <div class="text-sm font-bold bg-black/60 px-2 rounded inline-block">
                            {{ calculateHandScore(p.hand) }}
                            <span v-if="isFiveCardCharlie(p.hand)" class="text-purple-400 ml-1">‚òÖNg≈© Linh</span>
                        </div>
                        
                        <div v-if="p.status === 'bust'" class="text-red-500 font-bold text-xs uppercase bg-black px-1 mt-1 rounded">Qu·∫Øc!</div>
                        <div v-if="p.status === 'stand'" class="text-gray-300 text-xs mt-1">D·∫±n b√†i</div>
                        
                        <div v-if="p.result" 
                             :class="['absolute -top-6 left-1/2 transform -translate-x-1/2 font-bold text-lg px-2 py-1 rounded shadow-lg whitespace-nowrap animate-bounce', 
                                      p.result === 'WIN' ? 'bg-green-600 text-white' : (p.result === 'LOSE' ? 'bg-red-600 text-white' : 'bg-gray-500 text-white')]">
                            {{ p.result === 'WIN' ? 'TH·∫ÆNG' : (p.result === 'LOSE' ? 'THUA' : 'H√íA') }}
                            <span class="text-sm block text-center font-mono">{{ p.diffMoney }}</span>
                        </div>
                    </div>

                    <div v-if="currentTurnId === p.id" class="absolute -bottom-2 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[10px] border-b-yellow-400"></div>
                </div>
            </div>

            <div v-if="isMyTurn && !gameEnded" class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black to-transparent pt-10 pb-6 px-4 flex justify-center gap-6 z-20">
                <button @click="hit" class="bg-green-600 hover:bg-green-500 text-white font-bold py-4 px-8 rounded-full shadow-lg border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition text-xl flex items-center gap-2">
                    <span>üÉè</span> B·ªêC B√ÄI
                </button>
                <button @click="stand" class="bg-red-600 hover:bg-red-500 text-white font-bold py-4 px-8 rounded-full shadow-lg border-b-4 border-red-800 active:border-b-0 active:translate-y-1 transition text-xl flex items-center gap-2">
                    <span>üõë</span> D·∫∞N B√ÄI
                </button>
            </div>

            <div v-if="gameEnded && isMyHost" class="absolute bottom-0 left-0 w-full bg-black/80 p-6 flex justify-center z-20">
                <button @click="resetGame" class="bg-yellow-500 hover:bg-yellow-400 text-black font-extrabold py-3 px-10 rounded-full shadow-[0_0_20px_rgba(234,179,8,0.6)] text-xl animate-pulse">
                    CH∆†I V√ÅN M·ªöI ‚Üª
                </button>
            </div>
             <div v-if="gameEnded && !isMyHost" class="absolute bottom-0 left-0 w-full bg-black/80 p-6 flex justify-center text-gray-300 italic z-20">
                ƒê·ª£i ch·ªß ph√≤ng chia b√†i...
            </div>
        </div>

    </div>

    <script>
        const { createClient } = supabase;

        // --- ƒê√É T·ª∞ ƒê·ªòNG C·∫¨P NH·∫¨T ---
        const SUPABASE_URL = 'https://adzebisicproxcrqavmd.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkemViaXNpY3Byb3hjcnFhdm1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNzczMzAsImV4cCI6MjA4NTk1MzMzMH0.wrevdUEsEH9D8PSi-UDIp7p77NGWR2htVYgc7xwRF9I';

        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        const app = Vue.createApp({
            data() {
                return {
                    view: 'login',
                    showTutorial: false,
                    username: '',
                    roomIdInput: '',
                    roomId: '',
                    myId: crypto.randomUUID(),
                    players: [],
                    dealerHand: [],
                    dealerId: 'bot',
                    gameMode: 'bot',
                    gameState: 'waiting',
                    currentTurnId: null,
                    deck: [],
                    channel: null,
                    errorMessage: '',
                    hostId: null
                }
            },
            computed: {
                isMyHost() { return this.hostId === this.myId; },
                me() { return this.players.find(p => p.id === this.myId); },
                isMyTurn() { return this.currentTurnId === this.myId; },
                isDealerTurn() { return this.currentTurnId === this.dealerId; },
                gameEnded() { return this.gameState === 'ended'; },
                dealerPlayer() {
                     if (this.gameMode === 'solo' && this.dealerId !== 'bot') {
                         return this.players.find(p => p.id === this.dealerId);
                     }
                     return null;
                }
            },
            methods: {
                enterLobby() {
                    if(!this.username) return;
                    this.roomId = this.roomIdInput || 'room_' + Math.floor(Math.random() * 9000 + 1000);
                    this.view = 'lobby';
                    this.connectSupabase();
                },
                connectSupabase() {
                    this.channel = _supabase.channel(this.roomId, {
                        config: { presence: { key: this.myId } }
                    });

                    this.channel
                        .on('broadcast', { event: 'game_update' }, ({ payload }) => {
                            this.syncState(payload);
                        })
                        .on('presence', { event: 'sync' }, () => {
                            const state = this.channel.presenceState();
                            this.updatePlayerList(state);
                        })
                        .subscribe(async (status) => {
                            if (status === 'SUBSCRIBED') {
                                await this.channel.track({
                                    id: this.myId,
                                    name: this.username,
                                    money: 100000,
                                    joinedAt: Date.now()
                                });
                            }
                        });
                    
                    // L·∫Øng nghe actions
                    this.channel.on('broadcast', { event: 'player_action' }, ({ payload }) => {
                        if (!this.isMyHost) return;
                        if (payload.action === 'hit') this.handleHit(payload.playerId);
                        if (payload.action === 'stand') this.handleStand(payload.playerId);
                    });
                },
                updatePlayerList(state) {
                    const allUsers = [];
                    for (const key in state) { allUsers.push(state[key][0]); }
                    allUsers.sort((a, b) => a.joinedAt - b.joinedAt);
                    
                    if (allUsers.length > 0) { this.hostId = allUsers[0].id; }

                    const currentMoneyMap = {};
                    this.players.forEach(p => currentMoneyMap[p.id] = p.money);

                    this.players = allUsers.map(u => ({
                        id: u.id,
                        name: u.name,
                        money: currentMoneyMap[u.id] || u.money,
                        isHost: u.id === this.hostId,
                        hand: this.players.find(p => p.id === u.id)?.hand || [],
                        status: this.players.find(p => p.id === u.id)?.status || 'waiting',
                        result: this.players.find(p => p.id === u.id)?.result || '',
                        diffMoney: this.players.find(p => p.id === u.id)?.diffMoney || 0
                    }));
                },
                broadcastGame() {
                    if (!this.isMyHost) return;
                    const payload = {
                        players: this.players,
                        dealerHand: this.dealerHand,
                        dealerId: this.dealerId,
                        gameMode: this.gameMode,
                        gameState: this.gameState,
                        currentTurnId: this.currentTurnId
                    };
                    this.channel.send({ type: 'broadcast', event: 'game_update', payload });
                },
                syncState(payload) {
                    if (this.isMyHost) return;
                    this.players = payload.players;
                    this.dealerHand = payload.dealerHand;
                    this.dealerId = payload.dealerId;
                    this.gameMode = payload.gameMode;
                    this.gameState = payload.gameState;
                    this.currentTurnId = payload.currentTurnId;
                    if (this.gameState !== 'waiting' && this.view === 'lobby') this.view = 'game';
                },
                startGame(mode) {
                    if (mode === 'solo' && this.players.length !== 2) return this.errorMessage = 'C·∫ßn ƒë√∫ng 2 ng∆∞·ªùi!';
                    if (mode === 'multi' && this.players.length > 4) return this.errorMessage = 'T·ªëi ƒëa 4 ng∆∞·ªùi!';
                    this.errorMessage = '';
                    this.gameMode = mode;
                    this.resetGame();
                },
                resetGame() {
                    this.deck = this.createDeck();
                    this.dealerHand = [];
                    this.gameState = 'playing';
                    this.view = 'game';

                    if (this.gameMode === 'solo') this.dealerId = this.players[0].id; 
                    else this.dealerId = 'bot';

                    this.players.forEach(p => {
                        p.hand = [];
                        p.status = 'playing';
                        p.result = '';
                        p.diffMoney = 0;
                        if (this.gameMode === 'solo') {
                             if (p.id !== this.dealerId) p.money -= 1000;
                        } else {
                             p.money -= 1000;
                        }
                        p.hand.push(this.drawCard());
                        p.hand.push(this.drawCard());
                    });

                    if (this.gameMode === 'solo') {
                        const dealerObj = this.players.find(p => p.id === this.dealerId);
                        this.dealerHand = dealerObj.hand;
                    } else {
                        this.dealerHand = [this.drawCard(), this.drawCard()];
                    }

                    const nonDealerPlayers = this.players.filter(p => p.id !== this.dealerId);
                    if (nonDealerPlayers.length > 0) this.currentTurnId = nonDealerPlayers[0].id;
                    else this.botPlay();

                    this.broadcastGame();
                },
                hit() {
                    if (this.isMyHost) this.handleHit(this.myId);
                    else this.channel.send({ type: 'broadcast', event: 'player_action', payload: { action: 'hit', playerId: this.myId } });
                },
                stand() {
                    if (this.isMyHost) this.handleStand(this.myId);
                    else this.channel.send({ type: 'broadcast', event: 'player_action', payload: { action: 'stand', playerId: this.myId } });
                },
                handleHit(playerId) {
                    if (this.currentTurnId !== playerId) return;
                    const p = this.players.find(p => p.id === playerId);
                    p.hand.push(this.drawCard());
                    
                    // Check ng≈© linh (5 l√° <= 21)
                    if (p.hand.length === 5 && this.calculateHandScore(p.hand) <= 21) {
                         p.status = 'stand'; // T·ª± ƒë·ªông d·∫±n n·∫øu ng≈© linh
                         this.nextTurn();
                    } else if (this.calculateHandScore(p.hand) > 21) {
                        p.status = 'bust';
                        this.nextTurn();
                    }
                    this.broadcastGame();
                },
                handleStand(playerId) {
                    if (this.currentTurnId !== playerId) return;
                    this.players.find(p => p.id === playerId).status = 'stand';
                    this.nextTurn();
                    this.broadcastGame();
                },
                nextTurn() {
                    const nonDealerPlayers = this.players.filter(p => p.id !== this.dealerId);
                    const currIndex = nonDealerPlayers.findIndex(p => p.id === this.currentTurnId);
                    
                    if (currIndex !== -1 && currIndex < nonDealerPlayers.length - 1) {
                        this.currentTurnId = nonDealerPlayers[currIndex + 1].id;
                    } else {
                        this.currentTurnId = this.dealerId;
                        if (this.dealerId === 'bot') this.botPlay();
                    }
                },
                botPlay() {
                    const loop = () => {
                        const score = this.calculateHandScore(this.dealerHand);
                        // Bot logic: < 16 ho·∫∑c (16, 17 m·ªÅm) th√¨ b·ªëc
                        if (score < 16) {
                            setTimeout(() => {
                                this.dealerHand.push(this.drawCard());
                                this.broadcastGame();
                                if (this.calculateHandScore(this.dealerHand) > 21) this.endGame();
                                else loop();
                            }, 1000);
                        } else {
                            setTimeout(() => this.endGame(), 800);
                        }
                    };
                    loop();
                },
                endGame() {
                    this.gameState = 'ended';
                    const dealerScore = this.calculateHandScore(this.dealerHand);
                    const dealerBust = dealerScore > 21;
                    const dealerFiveCard = this.dealerHand.length === 5 && !dealerBust;

                    this.players.forEach(p => {
                        if (p.id === this.dealerId) return;

                        const playerScore = this.calculateHandScore(p.hand);
                        const playerBust = playerScore > 21;
                        const playerFiveCard = p.hand.length === 5 && !playerBust;
                        
                        let win = false;
                        let tie = false;

                        // Logic so b√†i
                        if (playerBust) {
                            win = false; // Player qu·∫Øc lu√¥n thua (k·ªÉ c·∫£ dealer qu·∫Øc - lu·∫≠t chung)
                        } else if (dealerFiveCard && !playerFiveCard) {
                            win = false; // Dealer ng≈© linh ƒÉn
                        } else if (playerFiveCard && !dealerFiveCard) {
                            win = true; // Player ng≈© linh ƒÉn
                        } else if (dealerBust) {
                            win = true; // Dealer qu·∫Øc, Player ko qu·∫Øc
                        } else {
                            if (playerScore > dealerScore) win = true;
                            else if (playerScore === dealerScore) tie = true;
                            else win = false;
                        }

                        if (win) {
                            p.result = 'WIN';
                            p.money += 2000;
                            p.diffMoney = '+1000';
                            if (this.gameMode === 'solo') this.players.find(d => d.id === this.dealerId).money -= 1000;
                        } else if (tie) {
                            p.result = 'DRAW';
                            p.money += 1000;
                            p.diffMoney = '0';
                        } else {
                            p.result = 'LOSE';
                            p.diffMoney = '-1000';
                            if (this.gameMode === 'solo') this.players.find(d => d.id === this.dealerId).money += 1000;
                        }
                    });
                    this.broadcastGame();
                },
                createDeck() {
                    const suits = ['‚ô†', '‚ô£', '‚ô¶', '‚ô•'];
                    const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
                    let deck = [];
                    for (let s of suits) for (let r of ranks) deck.push({ suit: s, rank: r });
                    return deck.sort(() => Math.random() - 0.5);
                },
                drawCard() { return this.deck.pop(); },
                getCardColor(c) { return (c.suit === '‚ô¶' || c.suit === '‚ô•') ? 'red' : 'black'; },
                calculateHandScore(hand) {
                    let score = 0, aces = 0;
                    for (let c of hand) {
                        if (['J', 'Q', 'K'].includes(c.rank)) score += 10;
                        else if (c.rank === 'A') { aces += 1; score += 11; }
                        else score += parseInt(c.rank);
                    }
                    while (score > 21 && aces > 0) { score -= 10; aces -= 1; }
                    return score;
                },
                isFiveCardCharlie(hand) { return hand.length === 5 && this.calculateHandScore(hand) <= 21; },
                getDealerMoney() {
                    return (this.gameMode === 'solo' && this.dealerPlayer) ? this.dealerPlayer.money : 1000000;
                }
            }
        });
        app.mount('#app');
    </script>
</body>
</html>